[["data-integration.html", "Chapter 8 Data integration 8.1 Identifying anchors between scRNA-seq and scATAC-seq datasets 8.2 Annotate scATAC-seq cells via label transfer", " Chapter 8 Data integration The PBMC multiome data was built in the SeuratData package and was stored in a SeuratObject already, so we can download the data and directly start analyzing. This data only needs to be loaded once, and R will skip this step the next time you load it. ## Warning: The following packages are already installed and will not be ## reinstalled: pbmcMultiome # load both modalities pbmc.rna &lt;- LoadData(&quot;pbmcMultiome&quot;, &quot;pbmc.rna&quot;) pbmc.atac &lt;- LoadData(&quot;pbmcMultiome&quot;, &quot;pbmc.atac&quot;) pbmc.rna[[&quot;RNA&quot;]] &lt;- as(pbmc.rna[[&quot;RNA&quot;]], Class = &quot;Assay5&quot;) # repeat QC steps performed in the WNN vignette pbmc.rna &lt;- subset(pbmc.rna, seurat_annotations != &quot;filtered&quot;) pbmc.atac &lt;- subset(pbmc.atac, seurat_annotations != &quot;filtered&quot;) # Perform standard analysis of each modality independently RNA analysis pbmc.rna &lt;- NormalizeData(pbmc.rna) pbmc.rna &lt;- FindVariableFeatures(pbmc.rna) pbmc.rna &lt;- ScaleData(pbmc.rna) pbmc.rna &lt;- RunPCA(pbmc.rna) pbmc.rna &lt;- RunUMAP(pbmc.rna, dims = 1:30) # ATAC analysis add gene annotation information annotations &lt;- GetGRangesFromEnsDb(ensdb = EnsDb.Hsapiens.v86) seqlevelsStyle(annotations) &lt;- &quot;UCSC&quot; genome(annotations) &lt;- &quot;hg38&quot; Annotation(pbmc.atac) &lt;- annotations # We exclude the first dimension as this is typically correlated with sequencing depth pbmc.atac &lt;- RunTFIDF(pbmc.atac) pbmc.atac &lt;- FindTopFeatures(pbmc.atac, min.cutoff = &quot;q0&quot;) pbmc.atac &lt;- RunSVD(pbmc.atac) pbmc.atac &lt;- RunUMAP(pbmc.atac, reduction = &quot;lsi&quot;, dims = 2:30, reduction.name = &quot;umap.atac&quot;, reduction.key = &quot;atacUMAP_&quot;) p1 &lt;- DimPlot(pbmc.rna, group.by = &quot;seurat_annotations&quot;, reduction = &quot;umap&quot;,label = TRUE) + NoLegend() + ggtitle(&quot;RNA&quot;) p2 &lt;- DimPlot(pbmc.atac, group.by = &quot;orig.ident&quot;, reduction=&quot;umap.atac&quot;, label = FALSE) + NoLegend() + ggtitle(&quot;ATAC&quot;) p1 + p2 8.1 Identifying anchors between scRNA-seq and scATAC-seq datasets In order to identify ‘anchors’ between scRNA-seq and scATAC-seq experiments, we first generate a rough estimate of the transcriptional activity of each gene by quantifying ATAC-seq counts in the 2 kb-upstream region and gene body, using the GeneActivity() function in the Signac package. The ensuing gene activity scores from the scATAC-seq data are then used as input for canonical correlation analysis, along with the gene expression quantifications from scRNA-seq. We perform this quantification for all genes identified as being highly variable from the scRNA-seq dataset. # quantify gene activity gene.activities &lt;- GeneActivity(pbmc.atac, assay=&quot;ATAC&quot;,features = VariableFeatures(pbmc.rna)) # add gene activities as a new assay pbmc.atac[[&quot;ACTIVITY&quot;]] &lt;- CreateAssayObject(counts = gene.activities) # normalize gene activities DefaultAssay(pbmc.atac) &lt;- &quot;ACTIVITY&quot; pbmc.atac &lt;- NormalizeData(pbmc.atac) pbmc.atac &lt;- ScaleData(pbmc.atac, features = rownames(pbmc.atac)) # Identify anchors transfer.anchors &lt;- FindTransferAnchors(reference = pbmc.rna, query = pbmc.atac, features = VariableFeatures(object = pbmc.rna), reference.assay = &quot;RNA&quot;, query.assay = &quot;ACTIVITY&quot;, reduction = &quot;cca&quot;) 8.2 Annotate scATAC-seq cells via label transfer After identifying anchors, we can transfer annotations from the scRNA-seq dataset onto the scATAC-seq cells. The annotations are stored in the seurat_annotations field, and are provided as input to the refdata parameter. The output will contain a matrix with predictions and confidence scores for each ATAC-seq cell. celltype.predictions &lt;- TransferData(anchorset = transfer.anchors, refdata = pbmc.rna$seurat_annotations, weight.reduction = pbmc.atac[[&quot;lsi&quot;]], dims = 2:30) pbmc.atac &lt;- AddMetaData(pbmc.atac, metadata = celltype.predictions) After performing transfer, the ATAC-seq cells have predicted annotations (transferred from the scRNA-seq dataset) stored in the predicted.id field. Since these cells were measured with the multiome kit, we also have a ground-truth annotation that can be used for evaluation. You can see that the predicted and actual annotations are extremely similar. Figure 8.1: Compare cell labels in integrated vs truth In this example, the annotation for an scATAC-seq profile is correctly predicted via scRNA-seq integration ~90% of the time. In addition, the prediction.score.max field quantifies the uncertainty associated with our predicted annotations. We can see that cells that are correctly annotated are typically associated with high prediction scores (&gt;90%), while cells that are incorrectly annotated are associated with sharply lower prediction scores (&lt;50%). Incorrect assignments also tend to reflect closely related cell types (i.e. Intermediate vs. Naive B cells). Figure 8.2: Prediction accuracy Figure 8.3: Prediction accuracy saveRDS(pbmc.atac,file=&quot;pbmc_atac_integrated.rds&quot;) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
